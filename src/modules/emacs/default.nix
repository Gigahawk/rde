{ config, lib, pkgs, inputs, username, ... }:
with lib;
let
  hm = config.home-manager.users.${username};
  emacs-with-pkgs = (pkgs.unstable.emacsPackagesGen pkgs.unstable.emacsGit).emacsWithPackages;
  cfg = config.rde.emacs;

  mkROFileOption = path:
    (mkOption {
      type = types.path;
      description = "Files autogenerated by rde";
      default = path;
      readOnly = true;
    });
in {

  imports = [ ];
  #rde-core
  #rde-defaults
  #
  options = {
    rde.emacs = {
      enable = mkEnableOption "Enable rde emacs";
      dir = mkOption {
        type = types.path;
        description =
          "Directory, where emacs configuration files will be placed.";
        default =
          "${config.home-manager.users.${username}.xdg.configHome}/emacs";
      };
      files = {
        init = mkROFileOption "${config.rde.emacs.dir}/init.el";
        early-init = mkROFileOption "${config.rde.emacs.dir}/early-init.el";
        rde-features =
          mkROFileOption "${config.rde.emacs.dir}/rde/rde-features.el";
        rde-variables =
          mkROFileOption "${config.rde.emacs.dir}/rde/rde-variables.el";
        custom = mkOption {
          type = types.path;
          description = "Path to custom.el.";
          default = "${
              config.home-manager.users.${username}.xdg.dataHome
            }/emacs/custom.el";
        };
      };

      # user-init = mkOption {
      #   type = types.path;
      #   description = "Can source"
      #   default = "${config.rde.emacs.dir}/user.el";
      # };
      # custom-file = mkFileOption "${config.rde.emacs.dir}/custom.el";

      config = mkOption {
        type = types.lines;
        description = ''
          Every feature adds use-package declaration(s) here.
          Don't use it for user defined configurations.'';
        default = "";
      };

      vars = mkOption {
        type = types.lines;
        description = "Every feature adds variable declaration(s) here.";
        default = "";
      };

      font = mkOption {
        type = types.str;
        default = config.rde.font;
      };
      fontSize = mkOption {
        type = types.int;
        default = config.rde.fontSize;
      };

    };
  };

  config = mkIf config.rde.emacs.enable {
    #    _module.args.emacs-dir = "${hm.xdg.configHome}" /emacs;
    home-manager.users."${username}" = {
      home.file."${cfg.files.init}".text = mkBefore (readFile ./init.el);
      home.file."${cfg.files.early-init}".source = ./early-init.el;
      home.file."${cfg.files.rde-features}".text = cfg.config
        + "(provide 'rde-features)";
      home.file."${cfg.files.rde-variables}".text = mkAfter (''
        (defconst rde/username "${username}" "Username prvoided by rde.")
        (defconst rde/test-var "test-value" "Just a test variable.")
        (defconst rde/custom-file "${cfg.files.custom}" "Path to custom.el.")
        (defconst rde/font
          (font-spec :family "${cfg.font}"
                     :weight 'semi-light
                     :size ${toString cfg.fontSize}))
              '' + ''
          (provide 'rde-variables)
        '');

      home.packages = with pkgs; [
        emacs-all-the-icons-fonts
        sqlite
        (emacs-with-pkgs (epkgs:
          with epkgs; [
            use-package
            nix-mode
            magit
            modus-operandi-theme
            org
            org-roam
            company-org-roam
            company
            ivy
            olivetti
            restart-emacs
            keycast
          ]))
      ];
    };
  };
}
